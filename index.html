<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tabla Tuner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-orange-600 mb-2 flex items-center justify-center gap-3">
                    <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                    </svg>
                    AI Tabla Tuner
                </h1>
                <p class="text-gray-600">AI-powered intelligent tabla tuning assistant</p>
            </div>

            <!-- Input Section -->
            <div class="grid md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Select Raga
                    </label>
                    <select id="ragaSelect" class="w-full p-3 border-2 border-orange-200 rounded-lg focus:border-orange-400 focus:outline-none">
                        <option value="">Choose a raga...</option>
                        <option value="Yaman">Yaman (Vadi: Ga, Samvadi: Ni)</option>
                        <option value="Bhairav">Bhairav (Vadi: Dha, Samvadi: Re)</option>
                        <option value="Bilawal">Bilawal (Vadi: Sa, Samvadi: Pa)</option>
                        <option value="Kafi">Kafi (Vadi: Pa, Samvadi: Sa)</option>
                        <option value="Bhairavi">Bhairavi (Vadi: Ma, Samvadi: Sa)</option>
                        <option value="Todi">Todi (Vadi: Dha, Samvadi: Ga)</option>
                        <option value="Puriya">Puriya (Vadi: Ga, Samvadi: Dha)</option>
                        <option value="Marwa">Marwa (Vadi: Re, Samvadi: Dha)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Singer's Scale (Sa Position)
                    </label>
                    <select id="scaleSelect" class="w-full p-3 border-2 border-orange-200 rounded-lg focus:border-orange-400 focus:outline-none">
                        <option value="">Select singer's Sa...</option>
                        <option value="C">C</option>
                        <option value="C#">C# / Db</option>
                        <option value="D">D</option>
                        <option value="D#">D# / Eb</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F# / Gb</option>
                        <option value="G">G</option>
                        <option value="G#">G# / Ab</option>
                        <option value="A">A</option>
                        <option value="A#">A# / Bb</option>
                        <option value="B">B</option>
                    </select>
                </div>
            </div>

            <!-- AI Recommendation Display -->
            <div id="aiRecommendation" class="hidden bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl p-6 mb-8">
                <h3 class="text-lg font-bold text-purple-700 mb-3">ðŸŽµ AI Recommendation</h3>
                <div id="recommendationContent" class="text-gray-700"></div>
            </div>

            <!-- Status Message -->
            <div id="statusMessage" class="hidden mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-center text-blue-700 font-medium"></div>

            <!-- Recording Control -->
            <button id="recordButton" class="w-full py-4 rounded-lg font-semibold text-white text-lg flex items-center justify-center gap-3 transition-colors bg-orange-500 hover:bg-orange-600 mb-8">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
                Start Recording & Detect Pitch
            </button>

            <!-- Frequency Display -->
            <div id="frequencyDisplay" class="hidden bg-gradient-to-r from-orange-100 to-amber-100 rounded-xl p-6 mb-8">
                <div class="text-center mb-4">
                    <p class="text-sm text-gray-600 mb-1">Detected Note</p>
                    <p id="noteDisplay" class="text-5xl font-bold text-orange-600">--</p>
                    <p id="frequencyValue" class="text-2xl text-gray-600 mt-2">0.00 Hz</p>
                </div>

                <div id="tuningStatus" class="text-center hidden">
                    <svg id="statusIcon" class="w-12 h-12 mx-auto mb-2" fill="currentColor" viewBox="0 0 24 24"></svg>
                    <p id="statusText" class="text-2xl font-bold">In Tune!</p>
                    <p id="centsOffset" class="text-lg mt-2">0 cents</p>
                </div>

                <!-- Visual Tuning Meter -->
                <div class="mt-6">
                    <div class="h-4 bg-gray-200 rounded-full overflow-hidden relative">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-1 h-6 bg-gray-800"></div>
                        </div>
                        <div id="tuningBar" class="h-full bg-orange-500 transition-all duration-300" style="width: 50%; margin-left: 0%;"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>Too Low</span>
                        <span>Perfect</span>
                        <span>Too High</span>
                    </div>
                </div>
            </div>

            <!-- AI Advice Button -->
            <button id="aiAdviceButton" class="w-full py-4 rounded-lg font-semibold text-white text-lg bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed mb-6 transition-colors">
                Get AI Tuning Advice
            </button>

            <!-- AI Advice Display -->
            <div id="aiAdviceDisplay" class="hidden bg-purple-50 border-2 border-purple-200 rounded-xl p-6">
                <h3 class="text-xl font-bold text-purple-700 mb-3">AI Tuning Guidance</h3>
                <div id="aiAdviceContent" class="prose prose-sm text-gray-700 whitespace-pre-wrap"></div>
            </div>
        </div>

        <!-- Info Section -->
        <div class="mt-6 bg-white rounded-xl p-6 shadow-lg">
            <h3 class="text-lg font-bold text-gray-800 mb-3">How to Use:</h3>
            <ol class="list-decimal list-inside space-y-2 text-gray-600">
                <li>Select the raga you're playing</li>
                <li>Select the singer's scale (Sa position)</li>
                <li>AI will recommend the ideal tabla tuning note</li>
                <li>Click "Start Recording" and allow microphone access</li>
                <li>Play your tabla - see real-time note detection and tuning guidance</li>
                <li>Click "Get AI Tuning Advice" for detailed instructions</li>
            </ol>
        </div>
    </div>

    <script>
        // Note frequencies (middle octave C4-B4)
        const noteFrequencies = {
            'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13,
            'E': 329.63, 'F': 349.23, 'F#': 369.99, 'G': 392.00,
            'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
        };

        // Sargam note mapping
        const sargamNotes = {
            'Sa': 0, 'Re': 2, 'Ga': 4, 'Ma': 5, 'Pa': 7, 'Dha': 9, 'Ni': 11
        };

        // State
        let isRecording = false;
        let audioContext = null;
        let analyser = null;
        let mediaStream = null;
        let animationFrame = null;
        let detectedFreq = null;
        let tuningOffset = 0;
        let recommendedNote = null;

        // DOM elements
        const recordButton = document.getElementById('recordButton');
        const statusMessage = document.getElementById('statusMessage');
        const frequencyDisplay = document.getElementById('frequencyDisplay');
        const noteDisplay = document.getElementById('noteDisplay');
        const frequencyValue = document.getElementById('frequencyValue');
        const tuningStatus = document.getElementById('tuningStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const centsOffset = document.getElementById('centsOffset');
        const tuningBar = document.getElementById('tuningBar');
        const aiAdviceButton = document.getElementById('aiAdviceButton');
        const aiAdviceDisplay = document.getElementById('aiAdviceDisplay');
        const aiAdviceContent = document.getElementById('aiAdviceContent');
        const aiRecommendation = document.getElementById('aiRecommendation');
        const recommendationContent = document.getElementById('recommendationContent');
        const ragaSelect = document.getElementById('ragaSelect');
        const scaleSelect = document.getElementById('scaleSelect');

        // Calculate note from frequency
        function frequencyToNote(freq) {
            const A4 = 440;
            const C0 = A4 * Math.pow(2, -4.75);
            const halfSteps = Math.round(12 * Math.log2(freq / C0));
            const octave = Math.floor(halfSteps / 12);
            const noteIndex = halfSteps % 12;
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            return { note: notes[noteIndex], octave: octave, halfSteps: halfSteps };
        }

        // Calculate cents difference from target note
        function getCentsOffset(freq, targetFreq) {
            return 1200 * Math.log2(freq / targetFreq);
        }

        // Get note frequency with octave
        function getNoteFrequency(note, octave) {
            const baseFreq = noteFrequencies[note];
            return baseFreq * Math.pow(2, octave - 4);
        }

        // Calculate recommended tabla tuning
        function calculateRecommendedTuning(raga, singerScale) {
            if (!raga || !singerScale) return null;

            // Get singer's Sa frequency
            const singerSaFreq = noteFrequencies[singerScale];
            
            // Tabla tuning recommendations based on raga
            const recommendations = {
                'Yaman': { sargam: 'Pa', reasoning: 'Pa (5th) complements Ga vadi' },
                'Bhairav': { sargam: 'Sa', reasoning: 'Sa provides strong foundation' },
                'Bilawal': { sargam: 'Sa', reasoning: 'Sa matches vadi note' },
                'Kafi': { sargam: 'Pa', reasoning: 'Pa matches vadi note' },
                'Bhairavi': { sargam: 'Ma', reasoning: 'Ma matches vadi note' },
                'Todi': { sargam: 'Pa', reasoning: 'Pa balances the raga' },
                'Puriya': { sargam: 'Pa', reasoning: 'Pa provides stability' },
                'Marwa': { sargam: 'Pa', reasoning: 'Pa grounds the sharp Re' }
            };

            const rec = recommendations[raga] || { sargam: 'Sa', reasoning: 'Sa is safest choice' };
            
            // Calculate target note (singer's scale + sargam interval)
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const singerIndex = noteNames.indexOf(singerScale);
            const interval = sargamNotes[rec.sargam];
            const targetIndex = (singerIndex + interval) % 12;
            const targetNote = noteNames[targetIndex];
            
            // Usually same octave or one octave higher
            const targetFreq = noteFrequencies[targetNote];
            const octaveAdjustment = targetFreq < singerSaFreq ? 1 : 0;

            return {
                note: targetNote,
                sargam: rec.sargam,
                reasoning: rec.reasoning,
                frequency: targetFreq * Math.pow(2, octaveAdjustment),
                octave: 4 + octaveAdjustment
            };
        }

        // Update recommendation display
        function updateRecommendation() {
            const raga = ragaSelect.value;
            const scale = scaleSelect.value;
            
            if (raga && scale) {
                const rec = calculateRecommendedTuning(raga, scale);
                if (rec) {
                    recommendedNote = rec;
                    recommendationContent.innerHTML = `
                        <p class="mb-2"><strong>Recommended Tabla Tuning:</strong> <span class="text-2xl font-bold text-purple-700">${rec.note}</span> (${rec.sargam} of ${scale})</p>
                        <p class="text-sm text-gray-600">Target: ${rec.frequency.toFixed(2)} Hz</p>
                        <p class="text-sm mt-2"><em>${rec.reasoning}</em></p>
                    `;
                    aiRecommendation.classList.remove('hidden');
                }
            } else {
                aiRecommendation.classList.add('hidden');
                recommendedNote = null;
            }
        }

        // Show status message
        function showStatus(message) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');
        }

        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        // Pitch detection using autocorrelation
        function detectPitch(analyser) {
            const bufferLength = analyser.fftSize;
            const buffer = new Float32Array(bufferLength);
            analyser.getFloatTimeDomainData(buffer);

            let bestCorrelation = 0;
            let bestOffset = -1;
            const sampleRate = audioContext.sampleRate;

            for (let offset = 1; offset < bufferLength / 2; offset++) {
                let correlation = 0;
                for (let i = 0; i < bufferLength / 2; i++) {
                    correlation += Math.abs(buffer[i] - buffer[i + offset]);
                }
                correlation = 1 - correlation / (bufferLength / 2);
                
                if (correlation > bestCorrelation) {
                    bestCorrelation = correlation;
                    bestOffset = offset;
                }
            }

            if (bestCorrelation > 0.9 && bestOffset > 0) {
                const frequency = sampleRate / bestOffset;
                return frequency;
            }
            return null;
        }

        // Start recording
        async function startRecording() {
            try {
                console.log('Requesting microphone access...');
                showStatus('Requesting microphone access...');

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Your browser does not support microphone access. Please use Chrome, Firefox, or Safari.');
                    return;
                }

                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });
                
                console.log('Microphone access granted');
                showStatus('Microphone active - play your tabla!');

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(mediaStream);
                
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                source.connect(analyser);

                isRecording = true;
                recordButton.innerHTML = `
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Stop Recording
                `;
                recordButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                recordButton.classList.add('bg-red-500', 'hover:bg-red-600');

                frequencyDisplay.classList.remove('hidden');
                analyzePitch();
            } catch (err) {
                console.error('Microphone error:', err);
                showStatus(`Error: ${err.message}`);
                alert(`Microphone access error: ${err.message}. Please allow microphone access.`);
            }
        }

        // Stop recording
        function stopRecording() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }
            if (audioContext) {
                audioContext.close();
            }
            
            isRecording = false;
            detectedFreq = null;
            
            recordButton.innerHTML = `
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
                Start Recording & Detect Pitch
            `;
            recordButton.classList.remove('bg-red-500', 'hover:bg-red-600');
            recordButton.classList.add('bg-orange-500', 'hover:bg-orange-600');
            
            frequencyDisplay.classList.add('hidden');
            hideStatus();
        }

        // Continuously analyze pitch
        function analyzePitch() {
            if (!analyser) return;

            const frequency = detectPitch(analyser);
            if (frequency && frequency > 100 && frequency < 1000) {
                detectedFreq = frequency;
                
                // Find closest note
                const noteInfo = frequencyToNote(frequency);
                const closestNoteFreq = getNoteFrequency(noteInfo.note, noteInfo.octave);
                const cents = getCentsOffset(frequency, closestNoteFreq);
                
                // Display note name with cents
                const centsDisplay = cents >= 0 ? `+${cents.toFixed(0)}` : cents.toFixed(0);
                noteDisplay.textContent = `${noteInfo.note}${noteInfo.octave}`;
                frequencyValue.textContent = `${frequency.toFixed(2)} Hz (${centsDisplay} cents)`;
                
                // If we have a recommended note, compare to it
                if (recommendedNote) {
                    tuningOffset = getCentsOffset(frequency, recommendedNote.frequency);
                    updateTuningStatus(tuningOffset);
                } else {
                    tuningStatus.classList.add('hidden');
                }
            }

            animationFrame = requestAnimationFrame(analyzePitch);
        }

        // Update tuning status display
        function updateTuningStatus(cents) {
            tuningStatus.classList.remove('hidden');
            
            const absCents = Math.abs(cents);
            
            if (absCents < 10) {
                statusIcon.innerHTML = '<path d="M5 12h14"/>';
                statusText.textContent = 'Perfect! In Tune!';
                statusText.className = 'text-2xl font-bold text-green-500';
                statusIcon.className = 'w-12 h-12 mx-auto mb-2 text-green-500';
            } else if (cents > 0) {
                statusIcon.innerHTML = '<path d="M7 11l5-5 5 5M12 6v12"/>';
                statusText.textContent = 'Too High - Loosen Straps';
                statusText.className = 'text-2xl font-bold text-red-500';
                statusIcon.className = 'w-12 h-12 mx-auto mb-2 text-red-500';
            } else {
                statusIcon.innerHTML = '<path d="M17 13l-5 5-5-5M12 18V6"/>';
                statusText.textContent = 'Too Low - Tighten Straps';
                statusText.className = 'text-2xl font-bold text-blue-500';
                statusIcon.className = 'w-12 h-12 mx-auto mb-2 text-blue-500';
            }
            
            centsOffset.textContent = `${absCents.toFixed(0)} cents ${cents > 0 ? 'sharp' : 'flat'}`;
            
            // Update tuning bar
            const barPosition = Math.max(0, Math.min(100, 50 + (cents / 100) * 50));
            tuningBar.style.width = '50%';
            tuningBar.style.marginLeft = `${barPosition - 50}%`;
        }

        // Get AI advice
        async function getAIAdvice() {
            const raga = ragaSelect.value;
            const scale = scaleSelect.value;
            
            if (!raga || !scale) {
                alert('Please select both raga and singer\'s scale first.');
                return;
            }
            
            if (!detectedFreq) {
                alert('Please start recording and play your tabla first.');
                return;
            }

            aiAdviceButton.textContent = 'Analyzing with AI...';
            aiAdviceButton.disabled = true;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `I'm tuning a tabla for Indian classical music. Here's the context:

RAGA: ${raga}
SINGER'S SCALE (Sa): ${scale}
RECOMMENDED TABLA TUNING: ${recommendedNote.note} (${recommendedNote.sargam} of ${scale})
TARGET FREQUENCY: ${recommendedNote.frequency.toFixed(2)} Hz

CURRENT TABLA:
- Detected frequency: ${detectedFreq.toFixed(2)} Hz
- Detected note: ${frequencyToNote(detectedFreq).note}${frequencyToNote(detectedFreq).octave}
- Tuning offset: ${tuningOffset.toFixed(0)} cents ${tuningOffset > 0 ? 'sharp (too high)' : 'flat (too low)'}

The tabla dayan is tuned by tightening or loosening the leather straps (gajra) around the drum. Please provide:

1. Clear direction: Should I tighten or loosen the straps?
2. How much adjustment is needed (rough estimate)?
3. Which position on the gajra to adjust (treat it like a clock face)?
4. Any tips for this specific raga
5. Warning if over-tightening is a risk

Keep response concise and practical for a tabla player actively tuning.`
                        }]
                    })
                });

                const data = await response.json();
                const advice = data.content.find(c => c.type === 'text')?.text || 'Unable to generate advice.';
                
                aiAdviceContent.textContent = advice;
                aiAdviceDisplay.classList.remove('hidden');
            } catch (err) {
                aiAdviceContent.textContent = 'Error connecting to AI. Please check your internet connection and try again.';
                aiAdviceDisplay.classList.remove('hidden');
            } finally {
                aiAdviceButton.textContent = 'Get AI Tuning Advice';
                aiAdviceButton.disabled = false;
            }
        }

        // Event listeners
        recordButton.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        aiAdviceButton.addEventListener('click', getAIAdvice);

        ragaSelect.addEventListener('change', updateRecommendation);
        scaleSelect.addEventListener('change', updateRecommendation);
    </script>
</body>
</html>
